app-id: io.itch.itch
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
base: org.winehq.Wine
base-version: stable-23.08
command: itch-run
separate-locales: false
finish-args:
#  - --allow=devel # For Wine crash handling
  - --allow=multiarch

  - --device=all

  - --share=ipc
  - --share=network

  - --socket=x11
  - --socket=wayland
  - --socket=pulseaudio

  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.freedesktop.ScreenSaver

  - --env=PATH=/app/bin:/usr/bin:/usr/lib/extensions/vulkan/gamescope/bin
  - --env=WINEPREFIX=/var/data/wine
  - --env=WINEDLLOVERRIDES=mscoree,mshtml='
  - --env=WINEDLLPATH=/app/dlls/lib32:/app/dlls/lib:/app/lib32/wine/wined3d:/app/lib/wine/wined3d
  - --env=LD_LIBRARY_PATH=/app/lib:/app/lib32
  - --env=GST_PLUGIN_SYSTEM_PATH=/app/lib/gstreamer-1.0:/usr/lib/x86_64-linux-gnu/gstreamer-1.0:/app/lib32/gstreamer-1.0:/usr/lib/i386-linux-gnu/gstreamer-1.0

  - --persist=.wine
  - --persist=.wine64
#  - --persist=.

inherit-extensions:
  - org.freedesktop.Platform.GL32
  - org.freedesktop.Platform.ffmpeg-full
  - org.freedesktop.Platform.Compat.i386
  - org.freedesktop.Platform.ffmpeg_full.i386
  - org.winehq.Wine.gecko
  - org.winehq.Wine.mono
  - org.winehq.Wine.DLLs

add-extensions:

  org.freedesktop.Platform.Compat.i386.Debug:
    directory: lib/debug/lib/i386-linux-gnu
    no-autodownload: true
    version: '23.08'

modules:
  - shared-modules/glu/glu-9.json

  - name: zypak
    sources:
      - type: git
        url: https://github.com/refi64/zypak
        tag: v2024.01.17
        commit: ded79a2f8a509adc21834b95a9892073d4a91fdc
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$

  - name: firejail
    buildsystem: autotools
    sources:
      - type: git
        url: https://github.com/netblue30/firejail.git
        tag: 0.9.72
        commit: 2551bc71f14052344666f3ca2ad67f5b798020b9
        x-checker-data:
          type: git
          tag-pattern: ^([\d.]+)$

  - name: gamescope
    buildsystem: simple
    build-commands:
      - mkdir -p /app/utils/gamescope

  - name: gamemode
    buildsystem: meson
    config-opts:
      - -Dwith-examples=false
      - -Dwith-util=false
      - -Dwith-sd-bus-provider=no-daemon
    post-install:
      - install -Dm755 ../data/gamemoderun -t /app/bin
    sources:
      - type: git
        url: https://github.com/FeralInteractive/gamemode.git
        tag: '1.7'
        commit: 4dc99dff76218718763a6b07fc1900fa6d1dafd9
        x-checker-data:
          type: git
          tag-pattern: ^([\d.]+)$
      - type: patch
        path: gamemode-pidfd-open.patch

  - name: itch
    buildsystem: simple
    build-commands:
      - install -D -t "${FLATPAK_DEST}/share/applications/" ./io.itch.itch.desktop
      - install -D -t "${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/" ./io.itch.itch.svg
      - install -D -t "${FLATPAK_DEST}/share/metainfo/" ./io.itch.itch.metainfo.xml
      - mv * /app/bin/
    sources:
      - type: file
        url: https://raw.githubusercontent.com/itchio/press-kit/304cdedcd99e6c0e8cd8d5b08b9bfe773b679579/logos/app-icon.svg
        dest-filename: io.itch.itch.svg
        sha256: eaf979c6c7c315a7004971bc82bbced24c06d7d4fff7f518d7cfd83863ea4285

      - type: file
        path: io.itch.itch.desktop

      - type: file
        path: io.itch.itch.metainfo.xml

      - type: file
        path: itch-run

      - type: archive
        strip-components: 0
        archive-type: zip
        url: https://broth.itch.zone/kitch/linux-amd64/26.1.3/archive/default
        sha256: 5a4079ddce5770dcddc947e64fe28e01de253d45b7a7ba24d4dc2aa48fb59a10
#        x-checker-data:
#          type: rotating-url
#          url: https://broth.itch.ovh/itch/linux-amd64/25.5.1/itch-linux-amd64.zip
#          pattern: https://broth.itch.ovh/itch/linux-amd64/v([0-9.]+)/itch-linux-amd64.zip

